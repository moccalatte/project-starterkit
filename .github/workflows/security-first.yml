name: Security First CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  security-gates:
    name: Security Gates (FAIL FAST)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # GATE 1: NO SECRETS IN CODE
      - name: Secret Detection (BLOCKING)
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

      # GATE 2: NO VULNERABLE DEPENDENCIES  
      - name: Dependency Vulnerability Scan
        if: hashFiles('**/package.json', '**/requirements.txt', '**/go.mod') != ''
        run: |
          if [ -f "package.json" ]; then
            npm audit --audit-level=high --production
          fi
          if [ -f "requirements.txt" ]; then
            pip install safety
            safety check --json
          fi
          if [ -f "go.mod" ]; then
            go list -json -deps ./... | nancy sleuth
          fi

      # GATE 3: INPUT VALIDATION REQUIRED
      - name: Security Code Scan
        uses: github/super-linter@v4
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_JAVASCRIPT_ES: true
          VALIDATE_PYTHON_BANDIT: true
          VALIDATE_DOCKERFILE_HADOLINT: true

  build-and-test:
    name: Build & Test (No Bypasses)
    runs-on: ubuntu-latest
    needs: security-gates
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: hashFiles('**/package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install & Test Node.js
        if: hashFiles('**/package.json') != ''
        run: |
          npm ci
          npm run lint
          npm test
          # NO || true BULLSHIT - FAILURES MUST BLOCK

      - name: Setup Python  
        if: hashFiles('**/requirements.txt') != ''
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install & Test Python
        if: hashFiles('**/requirements.txt') != ''
        run: |
          pip install -r requirements.txt
          flake8 . --count --statistics
          pytest --tb=short
          # NO || true BULLSHIT - FAILURES MUST BLOCK

      - name: Setup Go
        if: hashFiles('**/go.mod') != ''
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install & Test Go
        if: hashFiles('**/go.mod') != ''
        run: |
          go mod tidy
          go vet ./...
          go test -v ./...
          # NO || true BULLSHIT - FAILURES MUST BLOCK

  container-security:
    name: Container Security Scan
    runs-on: ubuntu-latest
    needs: build-and-test
    if: hashFiles('**/Dockerfile') != ''
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Container
        run: docker build -t security-scan:latest .

      - name: Container Vulnerability Scan (BLOCKING)
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy image \
            --exit-code 1 \
            --severity HIGH,CRITICAL \
            security-scan:latest

  deployment-ready:
    name: Production Deployment Gates
    runs-on: ubuntu-latest
    needs: [security-gates, build-and-test, container-security]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Security Checklist Validation
        run: |
          echo "âœ… Secrets scan passed"
          echo "âœ… Dependency vulnerabilities checked"  
          echo "âœ… Code security scan passed"
          echo "âœ… Container security verified"
          echo "âœ… All tests passed without bypasses"
          echo "ðŸš€ SAFE TO DEPLOY"